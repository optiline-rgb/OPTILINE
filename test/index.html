<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Contact Us | OPTILINE Agency</title>
<link rel="stylesheet" href="../assets/css/style.css">
<style>
  .honeypot-field {
    opacity: 0;
    position: absolute;
    left: -9999px;
  }
  .loading-spinner {
    display: none;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007cba;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 10px;
  }
  @keyframes spin { 0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);} }
  .form-messages {
    margin-top: 20px; /* extra space between button and messages */
    text-align: center;
  }
  #form-success {
    display: none;
    color: #00cc66;
    background: rgba(0,255,0,0.08);
    padding: 12px;
    border-radius: 6px;
    font-weight: 600;
  }
  #form-error {
    display: none;
    color: #ff4444;
    background: rgba(255,0,0,0.08);
    padding: 12px;
    border-radius: 6px;
    font-weight: 600;
  }
</style>
</head>
<body>
<main>
  <section id="contact">
    <div class="container">
      <form id="contact-form" class="contact-form" method="POST" novalidate>
        <h2>Project Inquiry</h2>

        <label for="name">Full Name *</label>
        <input type="text" id="name" name="name" required maxlength="100">

        <label for="email">Email Address *</label>
        <input type="email" id="email" name="email" required>

        <label for="telegram">Telegram *</label>
        <input type="text" id="telegram" name="telegram" placeholder="@username or +1234567890" required pattern="^(@[a-zA-Z0-9_]+|\+[0-9]+)$">

        <label for="message">Message *</label>
        <textarea id="message" name="message" rows="5" maxlength="1000" required></textarea>

        <!-- Honeypot -->
        <div class="honeypot-field" aria-hidden="true">
          <input type="text" id="website" name="website" tabindex="-1" autocomplete="off">
        </div>
        <div class="honeypot-field" aria-hidden="true">
          <input type="text" id="honeypot" name="honeypot" value="expected-value" tabindex="-1" autocomplete="off">
        </div>

        <button type="submit" id="submit-button" class="cta-button" disabled>
          <div class="submit-content">
            <div class="loading-spinner" id="loading-spinner"></div>
            <span id="submit-text">Submit Inquiry</span>
          </div>
        </button>

        <div class="form-messages">
          <div id="form-success"></div>
          <div id="form-error"></div>
        </div>
      </form>
    </div>
  </section>
</main>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const CONTACT_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbxhntVBOIV5hh4cVMfVIhJjxrMJfDayupZBHWeUwOls8FDkh6RPUYgsULeT9etNFJFa/exec"; // Replace with your deployed Apps Script URL
  const form = document.getElementById("contact-form");
  const submitButton = document.getElementById("submit-button");
  const submitText = document.getElementById("submit-text");
  const spinner = document.getElementById("loading-spinner");
  const successMsg = document.getElementById("form-success");
  const errorMsg = document.getElementById("form-error");
  const websiteField = document.getElementById("website");
  const honeypotField = document.getElementById("honeypot");
  const CLIENT_LIMIT_KEY = "contact_last_sent_ts";
  const COOLDOWN_MS = 120000;
  let currentToken = "";

  async function fetchToken() {
    try {
      const res = await fetch(CONTACT_WEBHOOK_URL + "?mode=getToken", { cache: "no-store" });
      const data = await res.json();
      if (data.status === "ok") {
        currentToken = data.token;
        submitButton.disabled = false;
      }
    } catch {
      showError("Security initialization failed. Refresh the page.");
    }
  }

  fetchToken();

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    hideMessages();

    const lastSent = localStorage.getItem(CLIENT_LIMIT_KEY);
    if (lastSent && Date.now() - parseInt(lastSent, 10) < COOLDOWN_MS) {
      showError("Please wait 2 minutes before sending another message.");
      return;
    }

    if (websiteField.value.trim() !== "" || honeypotField.value.trim() !== "expected-value") {
      showError("Security validation failed.");
      return;
    }

    const telegram = document.getElementById("telegram").value.trim();
    if (!/^(@[a-zA-Z0-9_]+|\+[0-9]+)$/.test(telegram)) {
      showError("Enter a valid Telegram username or phone number.");
      return;
    }

    if (!currentToken) {
      await fetchToken();
      if (!currentToken) {
        showError("Security token missing. Please refresh.");
        return;
      }
    }

    submitButton.disabled = true;
    spinner.style.display = "inline-block";
    submitText.textContent = "Submitting...";

    const formData = new FormData(form);
    formData.append("token", currentToken);

    try {
      const res = await fetch(CONTACT_WEBHOOK_URL, { method: "POST", body: formData });
      const json = await res.json();

      if (json.status === "ok") {
        form.reset();
        localStorage.setItem(CLIENT_LIMIT_KEY, Date.now().toString());
        showSuccess(json.message || "Your message has been sent successfully. We will contact you shortly.");
        startCooldown();
        currentToken = "";
        fetchToken();
      } else {
        throw new Error(json.message || "Submission failed.");
      }
    } catch (err) {
      showError(err.message);
      submitButton.disabled = false;
    } finally {
      spinner.style.display = "none";
      submitText.textContent = "Submit Inquiry";
    }
  });

  function hideMessages() {
    successMsg.style.display = "none";
    errorMsg.style.display = "none";
  }

  function showSuccess(msg) {
    successMsg.textContent = msg;
    successMsg.style.display = "block";
    errorMsg.style.display = "none";
  }

  function showError(msg) {
    errorMsg.textContent = msg;
    errorMsg.style.display = "block";
    successMsg.style.display = "none";
  }

  function startCooldown() {
    let remaining = 120;
    const timer = setInterval(() => {
      submitText.textContent = `Wait ${remaining}s`;
      remaining--;
      if (remaining <= 0) {
        clearInterval(timer);
        submitText.textContent = "Submit Inquiry";
        submitButton.disabled = false;
      }
    }, 1000);
  }
});
</script>
</body>
</html>
